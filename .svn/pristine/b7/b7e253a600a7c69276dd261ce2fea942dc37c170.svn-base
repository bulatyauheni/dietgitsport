package bulat.diet.helper_plus.activity;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.Set;
import java.util.TreeSet;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.StatusLine;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;
import org.json.JSONArray;
import org.json.JSONObject;

import android.app.AlertDialog;
import android.app.Dialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.database.Cursor;
import android.graphics.Color;
import android.os.AsyncTask;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextWatcher;
import android.view.KeyEvent;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.inputmethod.EditorInfo;
import android.view.inputmethod.InputMethodManager;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.AdapterView.OnItemSelectedListener;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.RelativeLayout;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.TextView.OnEditorActionListener;
import android.widget.Toast;
import bulat.diet.helper_plus.R;
import bulat.diet.helper_plus.adapter.DishAdapter;
import bulat.diet.helper_plus.adapter.DishArrayAdapter;
import bulat.diet.helper_plus.db.DishListHelper;
import bulat.diet.helper_plus.db.DishProvider;
import bulat.diet.helper_plus.db.TemplateDishHelper;
import bulat.diet.helper_plus.db.TodayDishHelper;
import bulat.diet.helper_plus.item.Dish;
import bulat.diet.helper_plus.item.DishType;
import bulat.diet.helper_plus.item.TodayDish;
import bulat.diet.helper_plus.utils.Constants;
import bulat.diet.helper_plus.utils.NetworkState;

public class DishListActivity extends BaseActivity {

	private static final String URL = Constants.URL_DISHBASE;
	protected static final int DIALOG_TYPE_NAME = 0;
	protected String selectedInemId;
	ListView dishesList;
	Spinner typeSpinner;
	String currDate;
	String id = null;
	TextView header;
	Cursor c;
	protected boolean templateFlag = false;
	DishListActivityGroup parent = null;
	private String parentName;
	private EditText searchEditText;
	private String searchString;
	private Button clearButton;
	private LinearLayout spinerLayot;
	private InputMethodManager imm;
	ArrayList<Dish> list = new ArrayList<Dish>();
	View viewToLoad;
	private RelativeLayout serchLayout;
	private TextView loadingView;
	private TextView badSearchView;
	private LinearLayout emptyLayout;
	private LinearLayout tabLayout;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		viewToLoad = LayoutInflater.from(this.getParent()).inflate(
				R.layout.dish_list, null);
		header = (TextView) viewToLoad.findViewById(R.id.textViewTitle);
		spinerLayot = (LinearLayout) viewToLoad.findViewById(R.id.spinerLayout);
		serchLayout = (RelativeLayout) viewToLoad
				.findViewById(R.id.searchLayout);
		tabLayout = (LinearLayout) viewToLoad.findViewById(R.id.tabLayout);
		emptyLayout = (LinearLayout) viewToLoad.findViewById(R.id.emptyLayout);
		loadingView = (TextView) viewToLoad.findViewById(R.id.textViewLoading);
		badSearchView = (TextView) viewToLoad
				.findViewById(R.id.textViewBadSearch);
		searchEditText = (EditText) viewToLoad
				.findViewById(R.id.editTextSearch);
		searchEditText.setOnEditorActionListener(searchEditorListener);
		searchEditText.addTextChangedListener(searchEditTextWatcher);
		clearButton = (Button) viewToLoad.findViewById(R.id.buttonClear);
		clearButton.setOnClickListener(new OnClickListener() {

			public void onClick(View v) {
				searchEditText.setText("");
			}
		});
		Bundle extras = getIntent().getExtras();
		parentName = null;
		if (extras != null) {
			currDate = extras.getString(DishActivity.DATE);
			id = extras.getString(AddTodayDishActivity.ID);
			templateFlag = extras.getBoolean(NewTemplateActivity.TEMPLATE);
			parentName = extras.getString(DishActivity.PARENT_NAME);
		}
		if (parentName == null) {
			if (DishListActivityGroup.class.getName().equals(
					getParent().getClass().getName())) {
				try {
					parent = (DishListActivityGroup) getParent();
				} catch (Exception e) {
					e.printStackTrace();
				}

			}

		}
		Button exitButton = (Button) viewToLoad.findViewById(R.id.buttonExit);
		exitButton.setOnClickListener(new OnClickListener() {

			public void onClick(View v) {
				// TODO Auto-generated method stub
				finish();
				System.exit(0);
			}
		});
		Button sportTab = (Button) viewToLoad.findViewById(R.id.sportTab);
		sportTab.setOnClickListener(new OnClickListener() {

			public void onClick(View v) {
				// TODO Auto-generated method stub
				try {
					Intent intent = new Intent();
					intent.setClass(getParent(), SportListActivity.class);
					DishListActivityGroup activityStack = (DishListActivityGroup) getParent();
					activityStack.push("SportListActivity", intent);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
		Button backButton = (Button) viewToLoad.findViewById(R.id.buttonBack);
		Button addButton = (Button) viewToLoad.findViewById(R.id.buttonAdd);
		Button addTypeButton = (Button) viewToLoad
				.findViewById(R.id.buttonAddType);
		RelativeLayout addTypeButtonLayout = (RelativeLayout) viewToLoad
				.findViewById(R.id.addTypeLayout);
		if (parent != null) {
			addButton.setVisibility(View.VISIBLE);
			tabLayout.setVisibility(View.VISIBLE);
			addTypeButtonLayout.setVisibility(View.VISIBLE);
		} else {
			backButton.setVisibility(View.VISIBLE);
			exitButton.setVisibility(View.GONE);
			serchLayout.setVisibility(View.VISIBLE);
		}
		backButton.setOnClickListener(new OnClickListener() {
			public void onClick(View v) {
				onBackPressed();
			}
		});

		addButton.setOnClickListener(new OnClickListener() {

			public void onClick(View v) {
				Intent intent = new Intent();
				try {
					intent.putExtra(AddTodayDishActivity.ADD, 1);
					intent.setClass(getParent(), AddDishActivity.class);
					intent.putExtra(AddTodayDishActivity.TITLE,
							getString(R.string.add_dish));
					intent.putExtra(AddDishActivity.DISH_TYPE,
							((DishType) typeSpinner.getSelectedItem())
									.getTypeKey() - 2);
					DishListActivityGroup activityStack = (DishListActivityGroup) getParent();
					activityStack.push("AddDishActivity", intent);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
		addTypeButton.setOnClickListener(new OnClickListener() {

			public void onClick(View v) {
				showDialog(DIALOG_TYPE_NAME);
			}
		});
		setContentView(viewToLoad);
	}

	public void showingDialogCancel(String id) {
		selectedInemId = id;
		AlertDialog.Builder builder = new AlertDialog.Builder(getParent());
		builder.setMessage(R.string.remove_dialog)
				.setPositiveButton(getString(R.string.yes), dialogClickListener)
				.setNegativeButton(getString(R.string.no), dialogClickListener)
				.show();
	}

	@Override
	protected void onDestroy() {
		// TODO Auto-generated method stub
		super.onDestroy();
		if (c != null)
			c.close();
	}

	@Override
	protected void onPause() {
		// TODO Auto-generated method stub
		super.onPause();
		if (c != null)
			c.close();
	}

	@Override
	protected void onResume() {
		// TODO Auto-generated method stub
		super.onResume();

		imm = (InputMethodManager) DishListActivity.this
				.getSystemService(Context.INPUT_METHOD_SERVICE);

		String header_text = getString(R.string.dish_list);
		setSpiner();
		header.setText(header_text);
		if (typeSpinner.getSelectedItem() != null) {
			c = DishListHelper.getDishesByCategory(getApplicationContext(),
					((DishType) typeSpinner.getSelectedItem()).getTypeKey());
			if (c != null) {
				try {
					DishAdapter da = new DishAdapter(this,
							getApplicationContext(), c, parent);
					dishesList = (ListView) findViewById(R.id.listViewDishes);
					dishesList.setAdapter(da);
				} catch (Exception e) {
					e.printStackTrace();

				} finally {
					c.close();
				}
			}
			dishesList.setOnItemClickListener(dishesListOnItemClickListener);
		}

	}

	private void setSpiner() {
		// TODO Auto-generated method stub
		typeSpinner = (Spinner) findViewById(R.id.dihs_type_spinner);
		ArrayList<DishType> types;
		if (parentName == null) {
			types = DishListHelper.getAllDishCategories(this);
		} else {
			types = DishListHelper.getUsingDishCategories(this);
		}

		ArrayAdapter<DishType> adapter = new ArrayAdapter<DishType>(this,
				android.R.layout.simple_spinner_item, types);

		adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
		typeSpinner.setAdapter(adapter);
		typeSpinner.setSelection(0);
		typeSpinner.setOnItemSelectedListener(spinnerListener);
	}

	@Override
	protected void onStop() {
		// TODO Auto-generated method stub
		super.onStop();
	}

	private OnItemSelectedListener spinnerListener = new OnItemSelectedListener() {

		public void onItemSelected(AdapterView<?> arg0, View arg1, int arg2,
				long arg3) {
			c.close();
			c = DishListHelper.getDishesByCategory(getApplicationContext(),
					((DishType) typeSpinner.getSelectedItem()).getTypeKey());
			if (c != null) {
				try {
					DishAdapter da = new DishAdapter(DishListActivity.this,
							getApplicationContext(), c, parent);
					// dishesList = (ListView)
					// viewToLoad.findViewById(R.id.listViewDishes);
					dishesList.setAdapter(da);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		}

		public void onNothingSelected(AdapterView<?> arg0) {
			// TODO Auto-generated method stub

		}
	};

	private OnItemClickListener dishesListOnItemClickListener = new OnItemClickListener() {

		public void onItemClick(AdapterView<?> arg0, View v, int arg2, long arg3) {
			Dish temp = null;
			try {
				DishListHelper
						.increaseCatrgoryPopularity(((DishType) typeSpinner
								.getSelectedItem()).getTypeKey(),
								getApplicationContext());
			} catch (Exception e) {
				e.printStackTrace();
			}
			Intent intent = new Intent();
			TextView name = (TextView) v.findViewById(R.id.textViewDishName);
			TextView idView = (TextView) v.findViewById(R.id.textViewId);
			TextView calorisity = (TextView) v
					.findViewById(R.id.textViewCaloricity);
			TextView fat = (TextView) v.findViewById(R.id.textViewFat);
			TextView carbon = (TextView) v.findViewById(R.id.textViewCarbon);
			TextView protein = (TextView) v.findViewById(R.id.textViewProtein);
			TextView typeView = (TextView) v
					.findViewById(R.id.textViewDishType);

			intent.putExtra(AddTodayDishActivity.DISH_NAME, name.getText());
			// adding in local db
			if ("0".equals(idView.getText())) {
				temp = (Dish) dishesList.getAdapter().getItem(arg2);
				temp.setId(String.valueOf(DishListHelper.addNewDish(temp,
						DishListActivity.this)));
			}
			if (id != null) {
				intent.putExtra(AddTodayDishActivity.TITLE,
						getString(R.string.edit_today_dish));
				intent.putExtra(AddTodayDishActivity.ID, id);
			} else {
				intent.putExtra(AddTodayDishActivity.TITLE,
						getString(R.string.add_today_dish));
				intent.putExtra(AddTodayDishActivity.ADD, 1);
			}
			intent.putExtra(AddTodayDishActivity.DISH_CALORISITY,
					Integer.valueOf(calorisity.getText().toString()));
			intent.putExtra(AddTodayDishActivity.DISH_FAT, fat.getText()
					.toString());
			intent.putExtra(AddTodayDishActivity.DISH_CARBON, carbon.getText()
					.toString());
			intent.putExtra(AddTodayDishActivity.DISH_PROTEIN, protein
					.getText().toString());
			intent.putExtra(AddTodayDishActivity.DISH_CATEGORY,
					((DishType) typeSpinner.getSelectedItem()).getTypeKey());
			intent.putExtra(AddTodayDishActivity.DISH_STAT_TYPE, typeView
					.getText().toString());
			intent.putExtra(DishActivity.DATE, currDate);
			intent.putExtra(DishActivity.PARENT_NAME, parentName);

			if (CalendarActivityGroup.class.getName().equals(
					getParent().getClass().getName())) {
				intent.putExtra(NewTemplateActivity.TEMPLATE, templateFlag);
				intent.setClass(getParent(), AddTodayDishActivity.class);
				CalendarActivityGroup activityStack = (CalendarActivityGroup) getParent();
				activityStack.push("AddTodayDishActivityCalendar", intent);
			} else if (DishActivityGroup.class.getName().equals(
					getParent().getClass().getName())) {
				try {
					/*
					 * if (!"0".equals(idView.getText().toString())) {
					 * DishListHelper.incDishPopularity(idView.getText()
					 * .toString(), DishListActivity.this); } else { if (temp !=
					 * null) { DishListHelper.incDishPopularity(temp.getId(),
					 * DishListActivity.this); } }
					 */
					intent.setClass(getParent(), AddTodayDishActivity.class);
					DishActivityGroup activityStack = (DishActivityGroup) getParent();
					activityStack.push("AddTodayDishActivity", intent);
				} catch (Exception e) {
					e.printStackTrace();
				}

			} else if (DishListActivityGroup.class.getName().equals(
					getParent().getClass().getName())) {
				try {

					intent.putExtra(AddTodayDishActivity.ID, idView.getText()
							.toString());
					intent.putExtra(AddTodayDishActivity.ADD, 0);
					intent.putExtra(AddTodayDishActivity.TITLE,
							getString(R.string.edit_dish));
					intent.putExtra(AddTodayDishActivity.DISH_FAT, fat
							.getText().toString());
					intent.putExtra(AddTodayDishActivity.DISH_CARBON, carbon
							.getText().toString());
					intent.putExtra(AddTodayDishActivity.DISH_PROTEIN, protein
							.getText().toString());
					intent.putExtra(AddDishActivity.DISH_TYPE,
							((DishType) typeSpinner.getSelectedItem())
									.getTypeKey() - 2);
					intent.setClass(getParent(), AddDishActivity.class);
					DishListActivityGroup activityStack = (DishListActivityGroup) getParent();
					activityStack.push("AddDishActivity", intent);
				} catch (Exception e) {
					e.printStackTrace();
				}

			}

		}
	};

	DialogInterface.OnClickListener dialogClickListener = new DialogInterface.OnClickListener() {
		public void onClick(DialogInterface dialog, int which) {
			switch (which) {
			case DialogInterface.BUTTON_POSITIVE:
				try {
					DishListHelper.removeDish(selectedInemId,
							DishListActivity.this);
					selectedInemId = null;
				} catch (Exception e) {
					e.printStackTrace();
				}
				break;

			case DialogInterface.BUTTON_NEGATIVE:
				selectedInemId = null;
				break;
			}
		}
	};

	private OnEditorActionListener searchEditorListener = new OnEditorActionListener() {

		public boolean onEditorAction(TextView v, int actionId, KeyEvent event) {

			if (actionId == EditorInfo.IME_ACTION_SEARCH) {
				searchString = searchEditText.getText().toString().trim();
				new SetFoundTask().execute();

				imm.hideSoftInputFromWindow(v.getWindowToken(), 0);
				return true;
			}
			return false;
		}

	};
	protected int couter_2;
	protected Object lastSearchString;
	private TextWatcher searchEditTextWatcher = new TextWatcher() {
		public void onTextChanged(CharSequence s, int start, int before,
				int count) {
		}

		public void beforeTextChanged(CharSequence s, int start, int count,
				int after) {
		}

		public void afterTextChanged(Editable s) {
			searchString = searchEditText.getText().toString().trim();
			if (!searchString.equals(lastSearchString)) {
				lastSearchString = searchString;
				if (searchString.length() == 0) {
					emptyLayout.setVisibility(View.GONE);
					badSearchView.setVisibility(View.GONE);
					loadingView.setVisibility(View.GONE);
					spinerLayot.setVisibility(View.VISIBLE);
					if (typeSpinner != null) {
						typeSpinner.getOnItemSelectedListener().onItemSelected(
								null, null, 0, 0);
					}
					clearButton.setVisibility(View.INVISIBLE);
					clear();
				} else {
					spinerLayot.setVisibility(View.GONE);
					clearButton.setVisibility(View.VISIBLE);
				}
				if (searchString.length() >= 3
						&& searchString.length() % 2 == 1) {
					new SetFoundTask().execute();
					couter_2++;
				}
			}
		}
	};
	public int count;
	private EditText typeName;

	private void clear() {
		searchString = "";
	}

	private class SetFoundTask extends AsyncTask<Void, Void, Void> {

		@Override
		protected void onPreExecute() {
			emptyLayout.setVisibility(View.VISIBLE);
			loadingView.setVisibility(View.VISIBLE);
		}

		@Override
		protected Void doInBackground(Void... params) {
			list = DishListHelper.searchInAll(searchString.toLowerCase(),
					getParent());
			try {
				searchString = URLEncoder.encode(searchString, "UTF-8");

			} catch (UnsupportedEncodingException e1) {
				// TODO Auto-generated catch block
				e1.printStackTrace();
			}

			Set<Dish> unicDish = new TreeSet<Dish>();
			unicDish.addAll(list);
			if (NetworkState.isOnline(getApplicationContext())) {
				count++;

				StringBuilder builder = new StringBuilder();
				HttpClient client = new DefaultHttpClient();
				searchString = searchString.replaceAll(" ", "%20");
				HttpGet httpGet = new HttpGet(URL + "?name=" + searchString
						+ "&full=1");
				try {
					HttpResponse response = client.execute(httpGet);
					StatusLine statusLine = response.getStatusLine();
					int statusCode = statusLine.getStatusCode();
					if (statusCode == 200) {
						HttpEntity entity = response.getEntity();
						InputStream content = entity.getContent();
						BufferedReader reader = new BufferedReader(
								new InputStreamReader(content));
						String line;
						while ((line = reader.readLine()) != null) {
							builder.append(line);
						}
					} else {

					}
					String resultString = builder.toString();
					try {
						JSONObject jsonRoot = new JSONObject(resultString);
						JSONArray jsonArray = new JSONArray(
								jsonRoot.getString("dishes"));
						for (int i = 0; i < jsonArray.length(); i++) {
							JSONObject jsonObject = jsonArray.getJSONObject(i);
							Dish d = new Dish(jsonObject.getString("name"),
									jsonObject.getString("name"),
									Integer.parseInt(jsonObject
											.getString("caloric")),
									Integer.parseInt(jsonObject
											.getString("category_id")), 0, 0,
									jsonObject.getString("type"),
									jsonObject.getString("fat").replace(',',
											'.'), jsonObject
											.getString("carbon").replace(',',
													'.'), jsonObject.getString(
											"protein").replace(',', '.'));
							unicDish.add(d);
						}
						list = new ArrayList<Dish>(unicDish);
					} catch (Exception e) {
						e.printStackTrace();
					}
				} catch (ClientProtocolException e) {
					e.printStackTrace();
				} catch (IOException e) {
					e.printStackTrace();
				}
				// return builder.toString();
			}
			return null;
		}

		@Override
		protected void onPostExecute(Void result) {
			setAdapter();
		}

	}

	private void setAdapter() {
		if (!NetworkState.isOnline(getApplicationContext())) {

			Toast.makeText(DishListActivity.this, getString(R.string.disonect),
					Toast.LENGTH_LONG).show();
		}
		emptyLayout.setVisibility(View.GONE);
		loadingView.setVisibility(View.GONE);
		if (list.size() > 0) {
			badSearchView.setVisibility(View.GONE);
			try {
				DishArrayAdapter da = new DishArrayAdapter(
						getApplicationContext(), R.layout.dish_list_row, list);
				dishesList.setAdapter(da);
				da.notifyDataSetChanged();

			} catch (Exception e) {
				e.printStackTrace();
			}
		} else {
			emptyLayout.setVisibility(View.VISIBLE);
			badSearchView.setVisibility(View.VISIBLE);
		}

	}

	@Override
	protected Dialog onCreateDialog(int id) {
		final Dialog dialog;
		Button buttonOk;
		Button nobutton;
		switch (id) {

		case DIALOG_TYPE_NAME:
			dialog = new Dialog(this.getParent());
			dialog.setContentView(R.layout.user_name_dialog);
			dialog.setTitle(R.string.types);

			typeName = (EditText) dialog.findViewById(R.id.editTextUserName);
			TextView maintext = (TextView) dialog
					.findViewById(R.id.textViewSerchActivityLevelLabel);
			maintext.setText(getText(R.string.type_save));
			TextView nametext = (TextView) dialog
					.findViewById(R.id.textViewNameLabel);
			nametext.setText(getText(R.string.type_name));
			buttonOk = (Button) dialog.findViewById(R.id.buttonYes);
			buttonOk.setOnClickListener(new OnClickListener() {

				public void onClick(View v) {

					if (typeName.getText().toString().trim().length() < 1) {
						typeName.setBackgroundColor(Color.RED);
					} else {
						DishListHelper.addType(typeName.getText().toString()
								.trim(), DishListActivity.this);
						setSpiner();
						dialog.cancel();
					}

				}
			});
			nobutton = (Button) dialog.findViewById(R.id.buttonNo);
			nobutton.setOnClickListener(new OnClickListener() {

				public void onClick(View v) {
					dialog.cancel();
				}
			});

			break;
		default:
			dialog = null;
		}

		return dialog;
	}

}
